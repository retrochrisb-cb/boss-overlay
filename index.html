<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Boss Overlay</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bar-width:420px; --bar-height:36px;
      --font: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --bg: rgba(0,0,0,0.6); --white:#fff;
      --hp-start:#ff6b6b; --hp-end:#8b0000;
    }
    html,body{height:100%;margin:0;background:transparent;font-family:var(--font);color:var(--white);}
    /* Admin panel */
    #controls{position:absolute;left:12px;top:12px;z-index:80;background:var(--bg);padding:10px;border-radius:8px;max-width:760px;}
    #controls input,#controls select,#controls button{margin:6px 6px 6px 0;padding:6px;border-radius:6px;border:0;background:#222;color:#fff;}
    #addBossForm{display:none;background:#111;padding:8px;border-radius:6px;margin-top:6px;}
    /* Viewer UI */
    #viewer{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding-top:36px;pointer-events:none;}
    #boss{max-width:420px;max-height:420px;image-rendering:pixelated;pointer-events:none;}
    #healthWrap{width:var(--bar-width);height:var(--bar-height);background:#222;border:4px solid #000;border-radius:6px;overflow:hidden;margin-top:12px;position:relative}
    #healthBar{height:100%;width:100%;background:linear-gradient(90deg,var(--hp-start),var(--hp-end));transition:width .25s linear}
    #healthPct{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-weight:bold;pointer-events:none}
    #damageText,#leaderboard,#mvp{margin-top:8px;text-align:center;pointer-events:none}
    /* small screens */
    @media (max-width:720px){ :root{--bar-width:320px} }
  </style>
</head>
<body>
  <!-- Admin controls (only visible in admin mode) -->
  <div id="controls" aria-hidden="true">
    <div>
      <label>Boss</label>
      <select id="bossSelector"></select>
      <label>Max HP</label>
      <input id="healthInput" type="number" value="1000" min="1" />
    </div>

    <div>
      <button id="resetBtn">Reset</button>
      <button id="addBossBtn">Add Boss</button>
      <button id="deleteBossBtn">Delete</button>
      <button id="publishBtn">Publish</button>
    </div>

    <div id="addBossForm" aria-hidden="true">
      <div><label>Name</label><input id="newBossName" type="text" placeholder="Christmas Ork" /></div>
      <div>
        <label>Normal PNG</label><input id="normalFile" type="file" accept="image/png" />
        <label>Damage PNG</label><input id="damageFile" type="file" accept="image/png" />
      </div>
      <div><button id="saveBossBtn">Save Boss</button><button id="cancelAddBtn">Cancel</button></div>
      <div style="font-size:12px;opacity:.9;margin-top:6px">Tip: keep PNGs under ~800px for reliable embedding.</div>
    </div>

    <hr style="border:0;border-top:1px solid #333;margin:8px 0" />

    <div>
      <label>Published.json URL</label>
      <input id="jsonUrlInput" type="text" style="width:360px" placeholder="https://retrochrisb-cb.github.io/boss-overlay/published.json" />
      <button id="saveJsonUrlBtn">Save</button>
      <button id="downloadPublishedBtn">Download published.json</button>
    </div>
    <div style="font-size:12px;margin-top:6px">Publish â†’ Download â†’ Upload `published.json` to your repo root for Studio to fetch.</div>
  </div>

  <!-- Viewer -->
  <div id="viewer" role="presentation">
    <img id="boss" src="" alt="boss" />
    <div id="healthWrap">
      <div id="healthBar"></div>
      <div id="healthPct">100%</div>
    </div>
    <div id="damageText"></div>
    <div id="leaderboard"></div>
    <div id="mvp"></div>
  </div>

<script>
/* ======= CONFIG ======= */
const DEFAULT_JSON = 'https://retrochrisb-cb.github.io/boss-overlay/published.json';
const KEY_BOSSES = 'bosses';
const KEY_PUBLISHED = 'publishedBoss';
const KEY_JSON = 'overlay_json_url';
const TRANSPARENT = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=';

/* Admin detection */
const IS_ADMIN = new URL(location.href).searchParams.get('admin') === '1';

/* Immediately hide admin controls in viewer mode to avoid flicker */
(function(){
  const c = document.getElementById('controls');
  if (c && !IS_ADMIN) c.style.display = 'none';
})();

/* Run all DOM logic after ready */
window.addEventListener('DOMContentLoaded', async () => {
  // Elements
  const bossImg = document.getElementById('boss');
  const healthBar = document.getElementById('healthBar');
  const healthPct = document.getElementById('healthPct');
  const damageText = document.getElementById('damageText');
  const leaderboard = document.getElementById('leaderboard');
  const mvp = document.getElementById('mvp');

  // Admin elements
  const controls = document.getElementById('controls');
  const bossSelector = document.getElementById('bossSelector');
  const healthInput = document.getElementById('healthInput');
  const resetBtn = document.getElementById('resetBtn');
  const addBossBtn = document.getElementById('addBossBtn');
  const deleteBossBtn = document.getElementById('deleteBossBtn');
  const publishBtn = document.getElementById('publishBtn');
  const addBossForm = document.getElementById('addBossForm');
  const saveBossBtn = document.getElementById('saveBossBtn');
  const cancelAddBtn = document.getElementById('cancelAddBtn');
  const newBossName = document.getElementById('newBossName');
  const normalFile = document.getElementById('normalFile');
  const damageFile = document.getElementById('damageFile');
  const jsonUrlInput = document.getElementById('jsonUrlInput');
  const saveJsonUrlBtn = document.getElementById('saveJsonUrlBtn');
  const downloadPublishedBtn = document.getElementById('downloadPublishedBtn');

  // State
  let bosses = JSON.parse(localStorage.getItem(KEY_BOSSES) || '{}');
  let published = null;
  let bossState = { health: 1000, max: 1000 };
  let damageLog = {};
  let lastPublishedTs = null;

  // Merge any embedded bosses (none by default)
  bosses = Object.assign({}, bosses);

  /* Helpers */
  function saveBosses(){ localStorage.setItem(KEY_BOSSES, JSON.stringify(bosses)); }
  function getJsonUrl(){
    const saved = localStorage.getItem(KEY_JSON) || jsonUrlInput.value || DEFAULT_JSON;
    if (!saved) return DEFAULT_JSON;
    if (saved.endsWith('/')) return saved + 'published.json';
    if (saved.endsWith('published.json')) return saved;
    // if looks like repo root without slash
    if (!saved.includes('published.json')) return saved + (saved.includes('?') ? '&' : '/') + 'published.json';
    return saved;
  }
  function setHealthUI(){ const pct = Math.max(0, Math.round((bossState.health / bossState.max) * 100)); healthBar.style.width = pct + '%'; healthPct.textContent = pct + '%'; }
  function updateLeaderboard(){ const arr = Object.entries(damageLog).sort((a,b)=>b[1]-a[1]); leaderboard.innerHTML = arr.length ? arr.map((r,i)=>`${i+1}. ${r[0]}: ${r[1]} dmg`).join('<br>') : 'No damage yet'; }
  function showDamageText(t){ damageText.textContent = t; setTimeout(()=>{ if (bossState.health>0) damageText.textContent=''; }, 2500); }
  function showMVP(){ const arr = Object.entries(damageLog).sort((a,b)=>b[1]-a[1]); if (arr.length){ mvp.innerHTML = `ðŸ† MVP: ${arr[0][0]} â€” ${arr[0][1]} dmg`; } else mvp.innerHTML = 'No contributors'; }

  function getNormalSrc(key){ const b = bosses[key]||{}; return b.normalData||b.normalUrl||TRANSPARENT; }
  function getDamageSrc(key){ const b = bosses[key]||{}; return b.damageData||b.damageUrl||getNormalSrc(key); }

  async function fileToDataUrl(file){
    return new Promise((res,rej)=>{
      try {
        const r = new FileReader();
        r.onload = ()=>res(r.result);
        r.onerror = e=>rej(e);
        r.readAsDataURL(file);
      } catch(e){ rej(e); }
    });
  }

  /* Populate boss dropdown */
  function populateBosses(){
    bossSelector.innerHTML = '';
    const keys = Object.keys(bosses);
    for (const k of keys){
      const o = document.createElement('option'); o.value = k; o.textContent = (bosses[k].name||k).replace(/_/g,' ');
      bossSelector.appendChild(o);
    }
    if (keys.length) bossSelector.value = keys[0];
  }

  /* Load published payload into viewer */
  function loadPublished(p){
    if (!p) return;
    published = p;
    bossState.max = p.maxHealth || 1000;
    bossState.health = bossState.max;
    damageLog = {};
    lastPublishedTs = p.timestamp || Date.now();
    bossImg.src = p.normalData || p.normalUrl || TRANSPARENT;
    setHealthUI();
    updateLeaderboard();
    mvp.innerHTML = '';
  }

  /* Fetch published.json once */
  async function fetchPublishedOnce(){
    const url = getJsonUrl();
    try {
      const r = await fetch(url, {cache:'no-store'});
      if (!r.ok) return;
      const j = await r.json();
      if (j && j.timestamp){
        loadPublished(j);
      }
    } catch(e){
      console.warn('published.json fetch failed', e);
    }
  }

  /* Poll published.json for changes (viewer only) */
  async function pollPublished(interval=7000){
    if (IS_ADMIN) return; // admin doesn't need polling
    const url = getJsonUrl();
    try {
      const r = await fetch(url, {cache:'no-store'});
      if (!r.ok) return;
      const j = await r.json();
      if (j && j.timestamp && j.timestamp !== lastPublishedTs){
        loadPublished(j);
      }
    } catch(e){
      // ignore transient errors
    } finally {
      setTimeout(()=>pollPublished(interval), interval);
    }
  }

  /* Apply damage visual and logic */
  function applyDamage(amount, user='Viewer', source='Test'){
    if (bossState.health <= 0) return;
    bossState.health = Math.max(0, bossState.health - amount);
    damageLog[user] = (damageLog[user]||0) + amount;
    setHealthUI();
    showDamageText(`${user} dealt ${amount} damage with ${source}!`);
    // swap image briefly
    try {
      const sel = bossSelector.value;
      const dmg = published ? (published.damageData||published.damageUrl) : getDamageSrc(sel);
      const norm = published ? (published.normalData||published.normalUrl) : getNormalSrc(sel);
      bossImg.src = dmg || norm || TRANSPARENT;
      setTimeout(()=>{ if (bossState.health>0) bossImg.src = norm || TRANSPARENT; }, 500);
    } catch(e){ console.warn(e); }
    updateLeaderboard();
    if (bossState.health === 0) setTimeout(()=>{ showMVP(); }, 800);
  }

  /* ===== Admin handlers (only attach if IS_ADMIN) ===== */
  populateBosses();

  if (IS_ADMIN){
    // show controls explicitly
    if (controls) controls.style.display = 'block';
    // load saved json url into input
    jsonUrlInput.value = localStorage.getItem(KEY_JSON) || DEFAULT_JSON;

    addBossBtn.addEventListener('click', ()=> {
      addBossForm.style.display = addBossForm.style.display === 'block' ? 'none' : 'block';
    });
    cancelAddBtn.addEventListener('click', ()=> addBossForm.style.display = 'none');

    saveBossBtn.addEventListener('click', async ()=>{
      const nameRaw = (newBossName.value||'').trim();
      if (!nameRaw){ alert('Enter a boss name'); return; }
      const key = nameRaw.replace(/\s+/g,'_').toLowerCase();
      try {
        let n = null, d = null;
        if (normalFile.files && normalFile.files[0]) n = await fileToDataUrl(normalFile.files[0]);
        if (damageFile.files && damageFile.files[0]) d = await fileToDataUrl(damageFile.files[0]);
        bosses[key] = bosses[key] || {};
        bosses[key].name = nameRaw;
        if (n) bosses[key].normalData = n;
        if (d) bosses[key].damageData = d;
        saveBosses();
        populateBosses();
        addBossForm.style.display = 'none';
        newBossName.value=''; normalFile.value=''; damageFile.value='';
        alert('Boss saved locally. Select it and click Publish.');
      } catch(e){
        console.error(e);
        alert('Failed to save boss. Try smaller PNGs (<800px).');
      }
    });

    deleteBossBtn.addEventListener('click', ()=>{
      const sel = bossSelector;
      if (!sel || !sel.value) { alert('No boss selected'); return; }
      if (!confirm('Delete ' + (sel.options[sel.selectedIndex]?.text || sel.value) + '?')) return;
      delete bosses[sel.value];
      saveBosses();
      populateBosses();
    });

    publishBtn.addEventListener('click', ()=>{
      const key = bossSelector.value;
      if (!key){ alert('No boss selected'); return; }
      const payload = {
        name: bosses[key].name || key,
        normalData: bosses[key].normalData || bosses[key].normalUrl || null,
        damageData: bosses[key].damageData || bosses[key].damageUrl || null,
        maxHealth: parseInt(healthInput.value,10) || 1000,
        timestamp: Date.now()
      };
      localStorage.setItem(KEY_PUBLISHED, JSON.stringify(payload));
      // set published in memory and UI
      loadPublished(payload);
      alert('Published locally. Click "Download published.json" to save and upload to repo root.');
    });

    downloadPublishedBtn.addEventListener('click', ()=>{
      const pub = localStorage.getItem(KEY_PUBLISHED);
      if (!pub){ alert('Nothing published yet. Click Publish first.'); return; }
      const blob = new Blob([JSON.stringify(JSON.parse(pub),null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'published.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(a.href);
    });

    saveJsonUrlBtn.addEventListener('click', ()=>{
      const v = jsonUrlInput.value || DEFAULT_JSON;
      localStorage.setItem(KEY_JSON, v);
      alert('Published.json URL saved.');
    });

    // Admin quick test: apply test damage from admin UI (for convenience)
    resetBtn.addEventListener('click', ()=>{
      bossState.max = parseInt(healthInput.value,10) || 1000;
      bossState.health = bossState.max;
      damageLog = {};
      setHealthUI(); updateLeaderboard(); damageText.textContent=''; mvp.textContent='';
      const sel = bossSelector.value;
      bossImg.src = getNormalSrc(sel);
    });

    // allow quick test by clicking boss image in admin
    bossImg.addEventListener('click', ()=> applyDamage(3, 'AdminTest', 'Click'));

  } else {
    // viewer mode: hide admin controls (defensive)
    if (controls) controls.remove();
  }

  /* Viewer initial load */
  // Try to load published.json (either from repo or localStorage)
  await fetchPublishedOnce();
  // If nothing loaded, try localStorage published
  if (!published){
    const pub = localStorage.getItem(KEY_PUBLISHED);
    if (pub) {
      try { loadPublished(JSON.parse(pub)); } catch(e){ console.warn('invalid local published', e); }
    }
  }
  // If still nothing, fallback to first stored boss
  if (!published){
    const keys = Object.keys(bosses);
    if (keys.length){
      bossImg.src = getNormalSrc(keys[0]);
      bossState.max = parseInt(healthInput.value,10) || 1000;
      bossState.health = bossState.max;
      setHealthUI();
    } else {
      bossImg.src = TRANSPARENT;
      bossState.max = 1000; bossState.health = 1000; setHealthUI();
    }
  }

  // Start polling in viewer mode so Studio updates automatically when you upload published.json
  if (!IS_ADMIN) setTimeout(()=>pollPublished(), 2000);

  /* Expose small debug helpers on window for convenience */
  window.__bossOverlay = {
    bosses: ()=>JSON.parse(localStorage.getItem(KEY_BOSSES)||'{}'),
    published: ()=>JSON.parse(localStorage.getItem(KEY_PUBLISHED)||'null'),
    applyDamage: applyDamage,
    reloadPublished: fetchPublishedOnce
  };

}); // end DOMContentLoaded
</script>
</body>
</html>







